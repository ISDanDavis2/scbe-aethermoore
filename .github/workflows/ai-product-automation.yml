name: AI Product Automation

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      product_name:
        description: Product name
        required: true

env:
  ZAPIER_WEBHOOK: ${{ secrets.ZAPIER_WEBHOOK_URL }}

jobs:
  ai-analyze:
    runs-on: ubuntu-latest
    outputs:
      description: ${{ steps.ai.outputs.desc }}
    steps:
      - uses: actions/checkout@v4
      - name: AI Analysis
        id: ai
        uses: anthropics/anthropic-bedrock-action@v1
        with:
          prompt: Analyze ${{ github.event.release.name }} for sales

  trigger-zapier:
    needs: ai-analyze
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Zapier
        run: |
          curl -X POST $ZAPIER_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{"product": "${{ github.event.release.name }}", "desc": "${{ needs.ai-analyze.outputs.description }}"}'

  sync-notion:
    needs: ai-analyze
    runs-on: ubuntu-latest
    steps:
      - name: Sync to Notion
        run: |
          curl -X POST https://api.notion.com/v1/pages \
            -H 'Authorization: Bearer ${{ secrets.NOTION_API_KEY }}' \
            -H 'Notion-Version: 2022-06-28' \
            -d '{"parent":{"database_id":"${{ secrets.NOTION_DB_ID }}"},"properties":{"Name":{"title":[{"text":{"content":"${{ github.event.release.name }}"}}]},"Status":{"select":{"name":"Ready to Sell"}}}}'

  deploy-aws:
    needs: trigger-zapier
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      - name: Update Lambda
        run: aws lambda invoke --function-name scbe-product-sync out.json
